"use client";

import { useState } from "react";
import { BaseCard } from "@/components/BaseCard";
import { Wallets } from "./Walllets";
import { Balance } from "./Balance";
import { Dominance } from "./Dominance";
import { MonthlyDominance } from "./MonthlyDominance";
import { AccountBalance } from "./AccountBalance";
import { User } from "./User";
import { TotalBalance } from "./TotalBalance";
import { FunctionalButton } from "./FunctionalButtons";
import {
  useQueryListWallets,
  useQueryGetAvailableYears,
  EVENT_WalletGetBalanceHistory,
  EVENT_WalletGetMonthlyDominance,
} from "@/utils/generated/hooks";
import { BaseModal } from "@/components/modals/BaseModal";
import { CreateWalletForm } from "@/components/modals/forms/CreateWalletForm";
import { AddTransactionForm } from "@/components/modals/forms/AddTransactionForm";
import { TransferMoneyForm } from "@/components/modals/forms/TransferMoneyForm";
import { useQueryClient } from "@tanstack/react-query";
import {
  EVENT_WalletListWallets,
  EVENT_WalletGetTotalBalance,
  EVENT_TransactionListTransactions,
} from "@/utils/generated/hooks";

type ModalType = "add-transaction" | "transfer-money" | "create-wallet" | null;

export default function Home() {
  const queryClient = useQueryClient();
  const [modalType, setModalType] = useState<ModalType>(null);

  const getListWallets = useQueryListWallets(
    {
      pagination: { page: 1, pageSize: 10, orderBy: "", order: "" },
    },
    { refetchOnMount: "always" },
  );

  // Fetch available years once and pass to child components
  const { data: availableYearsData } = useQueryGetAvailableYears(
    {},
    { refetchOnMount: "always" },
  );

  // Use available years from API, or default to current year if no transactions
  const availableYears = availableYearsData?.years?.length
    ? availableYearsData.years
    : [new Date().getFullYear()];

  const handleModalClose = () => setModalType(null);

  const handleModalSuccess = () => {
    queryClient.invalidateQueries({
      predicate: (query) => {
        const key = query.queryKey[0] as string;
        return [
          EVENT_WalletListWallets,
          EVENT_WalletGetTotalBalance,
          EVENT_TransactionListTransactions,
          EVENT_WalletGetBalanceHistory,
          EVENT_WalletGetMonthlyDominance,
        ].includes(key);
      },
    });
    handleModalClose();
  };

  const getModalTitle = () => {
    switch (modalType) {
      case "add-transaction":
        return "Add Transaction";
      case "transfer-money":
        return "Transfer Money";
      case "create-wallet":
        return "Create Wallet";
      default:
        return "";
    }
  };

  return (
    <div className="lg:grid lg:grid-cols-[70%_30%] lg:divide-x-2 lg:min-h-0">
      {/* Mobile-optimized header with Total Balance */}
      {/* Simplified gradient - cleaner on mobile, removed on desktop */}
      <div className="lg:hidden bg-gradient-to-b from-primary-50 to-neutral-50 px-3 py-4 mb-2">
        <div className="w-full max-w-md mx-auto">
          <TotalBalance />
        </div>
      </div>

      {/* Main content area - mobile-optimized spacing */}
      <div className="flex justify-center px-3 py-2 lg:py-4 lg:px-4 pb-20 lg:pb-4">
        <div className="w-full max-w-4xl">
          {/* Section: My Wallets - always at top */}
          <section className="mb-3 lg:mb-4">
            <h2 className="text-lg sm:text-xl lg:text-2xl font-bold text-neutral-800 mb-2">
              My Wallets
            </h2>
            <BaseCard className="rounded-sm sm:rounded-lg p-3 sm:p-5">
              <Wallets getListWallets={getListWallets} />
            </BaseCard>
          </section>

          {/* Section: Total Balance Fluctuation */}
          <section className="mb-3 lg:mb-4">
            <h2 className="text-lg sm:text-xl lg:text-2xl font-bold text-neutral-800 mb-2">
              Balance Trend
            </h2>
            <BaseCard className="rounded-sm sm:rounded-lg p-3 sm:p-5">
              <Balance availableYears={availableYears} />
            </BaseCard>
          </section>

          {/* Mobile: Collapsible sections for less critical data */}
          {/* Desktop: Always visible */}
          <details className="lg:open group mb-3 lg:mb-4">
            <summary className="cursor-pointer list-none">
              <h2 className="text-lg sm:text-xl lg:text-2xl font-bold text-neutral-800 mb-2 flex items-center justify-between">
                Analytics
                <svg className="w-5 h-5 lg:hidden transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                </svg>
              </h2>
            </summary>
            <div className="space-y-3 lg:space-y-4">
              {/* Dominance */}
              <div>
                <h3 className="text-base sm:text-lg font-semibold text-neutral-700 mb-2">
                  Dominance
                </h3>
                <BaseCard mobileOptized noMobileMargin>
                  <Dominance availableYears={availableYears} />
                </BaseCard>
              </div>

              {/* Monthly Dominance */}
              <div>
                <h3 className="text-base sm:text-lg font-semibold text-neutral-700 mb-2">
                  Monthly Dominance
                </h3>
                <BaseCard mobileOptimized noMobileMargin>
                  <MonthlyDominance availableYears={availableYears} />
                </BaseCard>
              </div>

              {/* Account Balance */}
              <div>
                <h3 className="text-base sm:text-lg font-semibold text-neutral-700 mb-2">
                  Account Balance
                </h3>
                <BaseCard mobileOptimized noMobileMargin>
                  <AccountBalance availableYears={availableYears} />
                </BaseCard>
              </div>
            </div>
          </details>
        </div>
      </div>

      {/* Desktop sidebar - hidden on mobile */}
      <div className="hidden lg:block px-4">
        <div className="grid divide-y-2 sticky top-4">
          <User />
          <TotalBalance />
          <FunctionalButton onOpenModal={(type) => setModalType(type)} />
        </div>
      </div>

      {/* Modals */}
      <BaseModal
        isOpen={modalType !== null}
        onClose={handleModalClose}
        title={getModalTitle()}
      >
        {modalType === "add-transaction" && (
          <AddTransactionForm onSuccess={handleModalSuccess} />
        )}
        {modalType === "transfer-money" && (
          <TransferMoneyForm onSuccess={handleModalSuccess} />
        )}
        {modalType === "create-wallet" && (
          <CreateWalletForm onSuccess={handleModalSuccess} />
        )}
      </BaseModal>
    </div>
  );
}
