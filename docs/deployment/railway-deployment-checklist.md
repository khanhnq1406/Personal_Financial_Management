# Railway Deployment Checklist

Use this checklist when deploying the WealthJourney Go backend to Railway.

## Prerequisites

- [ ] Railway account created
- [ ] Railway CLI installed (`npm i -g @railway/cli`)
- [ ] Railway project created
- [ ] PostgreSQL database provisioned in Railway project

## Environment Variables Setup

### Required Variables

- [ ] `DATABASE_URL` - Auto-generated by Railway PostgreSQL (use internal URL)
- [ ] `REDIS_URL` - Redis connection string
- [ ] `JWT_SECRET` - Random secure string (generate with `openssl rand -base64 32`)
- [ ] `GOOGLE_CLIENT_ID` - Google OAuth client ID
- [ ] `GOOGLE_CLIENT_SECRET` - Google OAuth client secret

### Railway-Specific Variables (Alpine Fix)

- [ ] `ENABLE_ALPINE_PRIVATE_NETWORKING=true` - **CRITICAL** for Alpine containers

### Database Connection Pool (Railway Free Tier Optimized)

- [ ] `DB_MAX_OPEN_CONNS=10` (default: 15)
- [ ] `DB_MAX_IDLE_CONNS=3` (default: 5)
- [ ] `DB_CONN_MAX_LIFETIME=30m` (default: 1h)
- [ ] `DB_CONN_MAX_IDLE_TIME=5m` (default: 10m)

### Optional Variables

- [ ] `PORT` - Auto-detected by Railway (default: 8080)
- [ ] `GIN_MODE=release` - Production mode
- [ ] `LOG_LEVEL=info` - Log verbosity

## Deployment Steps

### 1. Initial Deployment

```bash
# Login to Railway
railway login

# Link to your project
railway link

# Deploy
railway up
```

### 2. Verify Deployment

- [ ] Check deployment logs: `railway logs`
- [ ] Verify "Database connected and migrated successfully" log message
- [ ] Check health endpoint: `curl https://your-app.railway.app/health`
- [ ] Verify no "connection refused" errors in keep-alive logs

### 3. Monitor Database Keep-Alive

Watch logs for keep-alive job:

```bash
railway logs --filter "keep-alive"
```

**Expected log pattern (healthy):**
```
Database keep-alive job started (runs every 2m0s)
Database keep-alive ping success
Database keep-alive ping success
Database keep-alive ping success | Pool stats: open=5, in_use=2, idle=3
```

**Problem log pattern (needs investigation):**
```
Database keep-alive ping failed (1/5 consecutive): dial tcp [...]:5432: connect: connection refused
Database keep-alive ping failed (2/5 consecutive): dial tcp [...]:5432: connect: connection refused
```

### 4. Troubleshooting Connection Issues

#### Problem: "connection refused" errors

**Check:**
1. [ ] Is `ENABLE_ALPINE_PRIVATE_NETWORKING=true` set?
2. [ ] Is the database using internal URL (postgres.railway.internal)?
3. [ ] Are connection pool settings within limits?

**Fix:**
- Set Alpine networking variable
- Reduce connection pool size
- Check Railway PostgreSQL metrics (connections count)

#### Problem: Circuit breaker opens

**Symptoms:**
```
Database keep-alive circuit breaker OPENED after 5 consecutive failures
Database keep-alive circuit breaker OPEN - skipping ping
```

**Check:**
1. [ ] Is PostgreSQL service running? (check Railway dashboard)
2. [ ] Are there too many connections? (max 100 on free tier)
3. [ ] Is there a Railway outage? (check status.railway.app)

**Fix:**
- Restart PostgreSQL service in Railway dashboard
- Close idle connections from other services
- Wait for circuit breaker cooldown (2 minutes)

#### Problem: "too many clients" error

**Symptoms:**
```
pq: sorry, too many clients already
```

**Check:**
1. [ ] How many services are connecting to PostgreSQL?
2. [ ] What are their connection pool settings?

**Fix:**
```
Total connections = (MaxOpenConns × Number of Services) + Buffer
If you have 3 services: 10 × 3 = 30 connections (safe)
If you have 10 services: reduce MaxOpenConns to 5 or 8
```

## Post-Deployment Verification

### Health Check Tests

```bash
# Basic health check
curl https://your-app.railway.app/health | jq

# Expected response (healthy):
{
  "status": "healthy",
  "timestamp": "2026-02-09T10:00:00Z",
  "database": {
    "status": "connected",
    "stats": {
      "max_open_connections": 10,
      "open_connections": 5,
      "in_use": 2,
      "idle": 3,
      "wait_count": 0
    }
  },
  "uptime": "1h23m45s"
}

# Expected response (unhealthy):
{
  "status": "unhealthy",
  "timestamp": "2026-02-09T10:00:00Z",
  "database": {
    "status": "disconnected",
    "error": "dial tcp [...]:5432: connect: connection refused"
  },
  "uptime": "1h23m45s"
}
```

### Database Keep-Alive Tests

Monitor logs for 10 minutes to verify keep-alive stability:

```bash
railway logs --filter "keep-alive" --tail 100
```

- [ ] No circuit breaker openings
- [ ] No consecutive ping failures
- [ ] Connection pool stats look healthy (idle > 0, wait_count = 0)

## Common Railway Free Tier Limitations

| Limitation                    | Impact                                        | Mitigation                           |
| ----------------------------- | --------------------------------------------- | ------------------------------------ |
| 100 max PostgreSQL connections| Connection exhaustion errors                  | Optimize connection pool settings    |
| No built-in connection pooling| Each service creates own connection pool      | Use lower MaxOpenConns per service   |
| Cold starts                   | First request after idle is slow              | Keep-alive job prevents database sleep|
| IPv6 networking for internal  | Alpine containers fail without flag           | Set ENABLE_ALPINE_PRIVATE_NETWORKING |
| 500MB RAM limit               | OOM kills under high load                     | Optimize memory usage, reduce goroutines|

## Monitoring and Alerts

### Recommended Monitoring

1. **Railway Metrics Dashboard**
   - Database connections count
   - Memory usage
   - CPU usage
   - Response times

2. **Health Check Endpoint**
   - Set up external monitoring (UptimeRobot, Pingdom)
   - Alert on `/health` returning 503

3. **Log Monitoring**
   - Set up log aggregation (Papertrail, Logtail)
   - Alert on "circuit breaker OPENED"
   - Alert on "connection refused" spikes

### Health Check Monitoring Setup (UptimeRobot)

```yaml
Monitor Type: HTTP(s)
URL: https://your-app.railway.app/health
Interval: 5 minutes
Expected Response: 200 OK
Alert on: Non-200 response or keyword "unhealthy"
```

## Rollback Plan

If deployment causes issues:

```bash
# Rollback to previous deployment
railway rollback

# Or redeploy specific commit
railway up --service backend --detach <commit-hash>
```

## References

- [Railway Private Networking](https://docs.railway.com/reference/private-networking)
- [Railway App Sleeping](https://docs.railway.com/reference/app-sleeping)
- [Environment Variables Guide](./railway-env-vars.md)
